# https://docs.github.com/en/actions/creating-actions/creating-a-composite-action
name: Tests
description: "Run a suite of tests on the draft runner to ensure it is ready for production"
inputs:
  json:
    description: "JSON stringified object containing all the inputs from the calling workflow"
    required: true
  secrets:
    description: "JSON stringified object containing all the secrets from the calling workflow"
    required: true
  variables:
    description: "JSON stringified object containing all the variables from the calling workflow"
    required: true
runs:
  using: "composite"

  # Add as many tests as we think necessary to establish
  # whether the runner image is ready for production CI runs.
  steps:
    - name: Check environment
      shell: bash --noprofile --norc -eo pipefail -x {0}
      run: |
        date
        id
        printenv

    - name: Check secrets
      shell: bash --noprofile --norc -eo pipefail -x {0}
      run : |
        ! printenv | grep -q ACTIONS_RUNNER_AUTH_TOKEN=
        ! printenv | grep -q ACTIONS_RUNNER_APP_KEY_B64=
        ! printenv | grep -q GH_TOKEN=
        ! printenv | grep -q GITHUB_TOKEN=

    - name: Check system
      shell: bash --noprofile --norc -eo pipefail -x {0}
      run: |
        cat /etc/os-release
        uname -a
        dpkg --print-architecture
        free -h
        df -h
        mount
        lsblk

    - name: Check devices
      shell: bash --noprofile --norc -eo pipefail -x {0}
      run: |
        ls -al /dev/

        echo "Testing stdout" >&1
        echo "Testing stderr" >&2
        echo "Testing stdout" >/dev/stdout
        echo "Testing stderr" >/dev/stderr

        echo "Testing stdout" 1> >(tee "$HOME"/stdout)
        echo "Testing stderr" 2> >(tee "$HOME"/stderr)

        script -q -e -c "echo 'Testing pseudo-terminal'"

        echo GITHUB_ENV=$GITHUB_ENV
        echo "test=GITHUB_ENV" | tee -a $GITHUB_ENV

        echo GITHUB_OUTPUT=$GITHUB_OUTPUT
        echo "test=GITHUB_OUTPUT" | tee -a $GITHUB_OUTPUT

        echo GITHUB_STEP_SUMMARY=$GITHUB_STEP_SUMMARY
        echo "Testing GITHUB_STEP_SUMMARY" | tee -a $GITHUB_STEP_SUMMARY

    - name: Check networking
      shell: bash --noprofile --norc -eo pipefail -x {0}
      run: |
        hostname

        ip addr
        ip link list
        ip route
        
        npm ping

        curl -fsSL https://raw.githubusercontent.com/dylanaraps/neofetch/7.1.0/neofetch | bash

    - name: Check docker
      shell: bash --noprofile --norc -eo pipefail -x {0}
      run: |
        docker info
        docker run hello-world

    - name: Check packages
      shell: bash --noprofile --norc -eo pipefail -x {0}
      run: |
        aws --version
        balena version
        buildah --version
        containerd --version
        ctr --version
        dockerd --version
        docker buildx version
        docker compose version
        gh version
        node --version
        npm --version
        podman --version
        python3 --version
        pwsh -Version
        runc --version
        skopeo --version
        socat -V
        yq --version
        zstd --version
